{% extends 'user_header_footer.html' %}

{% load static %}
{% block user_header_footer_style %}
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f7f7f7;
            color: #333;
        }
        .formContainer {
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4a4a4a;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .error {
            border-color: red !important;
        }
        .card-details {
            display: flex;
            gap: 15px;
        }
        .card-details > div:first-child {
            flex: 2;
        }
        .card-details > div {
            flex: 1;
        }
        .submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #45a049;
        }
        .card-icons {
            text-align: center;
            <!--justify-content: space-between;-->
            margin-bottom: 20px;
        }

        .card-icons img {
            width: 50px;
            height: auto;
        }
        <!--.fa-brands{-->
        <!--    height: 40px;-->
        <!--}-->
        .secure-note {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 20px;
        }
        .total-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .total-price {
            font-weight: bold;
            font-size: 1.2em;
        }

{% endblock user_header_footer_style %}


{% block mainContent %}

    <div class="container formContainer">
        <h1>Payment Information</h1>
        <div class="total-section">
            <div class="total-row">
                <span>Subtotal:</span>
                <span id="subtotal">â‚¹{{ hotel_rent }}</span>
                <span id="subtotal-original" style="display: none;">{{ hotel_rent }}</span>
            </div>
            <div class="total-row">
                <span>Tax:</span>
                <span id="taxes">â‚¹{{ taxes }}</span>
                <span id="taxes-original" style="display: none;">{{ taxes }}</span>
            </div>
            <hr>
            <div class="total-row">
                <span class="total-price">Total:</span>
                <span class="total-price" id="total">â‚¹{{ totalAmount}}</span>
                <span id="total-original" style="display: none;">{{ totalAmount }}</span>
            </div>
        </div>

        <div class="card-icons">
            <!-- Placeholder for card icons -->
            <!--<i class="fa-brands fa-cc-mastercard"></i>-->
            <!--<i class="fa-brands fa-cc-visa"></i>-->
            <!--<i class="fa-brands fa-cc-discover"></i>-->
            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard">
            <img src="https://img.icons8.com/?size=100&id=5JTcb83oDGrE&format=png&color=000000" alt="RuPay">
            <img src="{% static 'images/icons/maestro.png' %}" alt="Maestro">
            <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/Visa.svg" alt="Visa">
            <!--[Visa] [Mastercard] [Amex] [Discover]-->
        </div>

        <form id="payment-form" action = "/paymentConfirm/" method = "post">
            {% csrf_token %}
            <input type="hidden" name="checkInDate" value="{{ checkInDate }}">
            <input type="hidden" name="checkOutDate" value="{{ checkOutDate }}">
            <input type="hidden" name="hotel_id" value="{{ hotel_id }}">
            <input type="hidden" name="hotel_rent" value="{{ hotel_rent }}">
            <input type="hidden" name="taxes" value="{{ taxes }}">
            <input type="hidden" name="totalAmount" value="{{ totalAmount }}">
            <input type="hidden" name="hotelType" value = "{{ hotelType }}">
            <div class="form-group">
                <label for="card-name">Name on Card</label>
                <input type="text" id="card-name" name="card-name" required placeholder="John Smith">
            </div>

            <div class="form-group">
                <label for="card-number">Card Number</label>
                <input type="text" id="card-number" name="card-number" required placeholder="1234 5678 9012 3456">
            </div>

            <div class="form-group card-details">
                <div>
                    <label for="expiry-date">Expiry Date</label>
                    <input type="text" id="expiry-date" name="expiry-date" required placeholder="MM/YY">
                </div>
                <div>
                    <label for="cvv">CVV</label>
                    <input type="text" id="cvv" name="cvv" required placeholder="123" maxlength="4">
                </div>
            </div>

            <div class="form-group">
                <label for="billing-address">Billing Address</label>
                <input type="text" id="billing-address" name="billing-address" required placeholder="123 Main St">
            </div>

            <div class="form-group card-details">
                <div>
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" required placeholder="City">
                </div>
                <div>
                    <label for="zip">ZIP Code</label>
                    <input type="text" id="zip" name="zip" required placeholder="800014" maxlength="6">
                </div>
            </div>

            <div class="form-group">
                <label for="country">Country</label>
                <select id="country" name="country" required>
                    <option value="" disabled selected>Select your country</option>
                    <option value="in" data-currency="INR" data-symbol="â‚¹" data-rate="1">India</option>
                    <option value="ca" data-currency="CAD" data-symbol="C$" data-rate="0.016">Canada</option>
                    <option value="us" data-currency="USD" data-symbol="$" data-rate="0.012">USA</option>
                    <option value="au" data-currency="AUD" data-symbol="A$" data-rate="0.018">Australia</option>
                </select>
            </div>

            <button type="submit" class="submit-btn" id="pay-button">Pay Now â‚¹{{ totalAmount }}</button>
        </form>

        <p class="secure-note">
            <span>ðŸ”’ Secure Payment</span> | Your payment information is encrypted and secure.
        </p>
    </div>

    <script>
    function hotelRent(){
        return document.getElementById('subtotal').textContent;
    }
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('payment-form');
      const countrySelect = document.getElementById('country');
      const subtotalEl = document.getElementById('subtotal');
      const taxesEl = document.getElementById('taxes');
      const totalEl = document.getElementById('total');
      const payButton = document.getElementById('pay-button');

      // Get original values
      const originalSubtotal = document.getElementById('subtotal-original').textContent;
      const originalTaxes = document.getElementById('taxes-original').textContent;
      const originalTotal = document.getElementById('total-original').textContent;

      // Add event listener for country change
      countrySelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const currency = selectedOption.getAttribute('data-currency');
        const symbol = selectedOption.getAttribute('data-symbol');
        const rate = parseFloat(selectedOption.getAttribute('data-rate'));

        if (currency && rate) {
          // Convert prices
          const convertedSubtotal = (parseFloat(originalSubtotal) * rate).toFixed(2);
          const convertedTaxes = (parseFloat(originalTaxes) * rate).toFixed(2);
          const convertedTotal = (parseFloat(originalTotal) * rate).toFixed(2);

          // Update displayed prices
          subtotalEl.textContent = `${symbol}${convertedSubtotal}`;
          taxesEl.textContent = `${symbol}${convertedTaxes}`;
          totalEl.textContent = `${symbol}${convertedTotal}`;
          payButton.textContent = `Pay Now ${symbol}${convertedTotal}`;
        } else {
          // Revert to original INR prices
          subtotalEl.textContent = `â‚¹${originalSubtotal}`;
          taxesEl.textContent = `â‚¹${originalTaxes}`;
          totalEl.textContent = `â‚¹${originalTotal}`;
          payButton.textContent = `Pay Now â‚¹${originalTotal}`;
        }
      });

      form.addEventListener('submit', function(event) {
        // Prevent form submission to validate first
        event.preventDefault();

        // Get form fields
        const cardName = document.getElementById('card-name');
        const cardNumber = document.getElementById('card-number');
        const expiryDate = document.getElementById('expiry-date');
        const cvv = document.getElementById('cvv');
        const billingAddress = document.getElementById('billing-address');
        const city = document.getElementById('city');
        const zip = document.getElementById('zip');
        const country = document.getElementById('country');

        // Reset previous error styling
        const inputs = [cardName, cardNumber, expiryDate, cvv, billingAddress, city, zip, country];
        inputs.forEach(input => {
          input.style.borderColor = '';
        });

        // Validation flags
        let isValid = true;

        // Name validation - just check if not empty
        if (!cardName.value.trim()) {
          cardName.style.borderColor = 'red';
          isValid = false;
        }

        // Card number validation - should be 16 digits (spaces allowed)
        const cardNumberValue = cardNumber.value.replace(/\s/g, '');
        if (!/^\d{16}$/.test(cardNumberValue)) {
          cardNumber.style.borderColor = 'red';
          isValid = false;
        }

        // Expiry date validation - MM/YY format
        if (!/^(0[1-9]|1[0-2])\/([0-9]{2})$/.test(expiryDate.value)) {
          expiryDate.style.borderColor = 'red';
          isValid = false;
        } else {
          // Check if card is expired
          const [month, year] = expiryDate.value.split('/');
          const expiryDateObj = new Date(2000 + parseInt(year), parseInt(month) - 1);
          const today = new Date();
          if (expiryDateObj < today) {
            expiryDate.style.borderColor = 'red';
            isValid = false;
          }
        }

        // CVV validation - 3 or 4 digits
        if (!/^\d{3,4}$/.test(cvv.value)) {
          cvv.style.borderColor = 'red';
          isValid = false;
        }

        // Basic validation for address, city
        if (!billingAddress.value.trim()) {
          billingAddress.style.borderColor = 'red';
          isValid = false;
        }

        if (!city.value.trim()) {
          city.style.borderColor = 'red';
          isValid = false;
        }

        // ZIP code validation - basic check for 5-6 digits
        if (!/^\d{5,6}$/.test(zip.value)) {
          zip.style.borderColor = 'red';
          isValid = false;
        }

        // Country validation
        if (!country.value) {
          country.style.borderColor = 'red';
          isValid = false;
        }

        // If all validations pass, submit the form
        if (isValid) {
          form.submit();
        } else {
          // Show a simple error message
          alert('Please fill all fields correctly');
        }
      });

      // Format card number as user types (add spaces after every 4 digits)
      const cardNumber = document.getElementById('card-number');
      cardNumber.addEventListener('input', function() {
        let value = this.value.replace(/\s/g, '');
        if (value.length > 16) {
          value = value.substr(0, 16);
        }
        // Add a space after every 4 digits
        this.value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
      });

      // Format expiry date as user types (add / after 2 digits)
      const expiryDate = document.getElementById('expiry-date');
      expiryDate.addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 4) {
          value = value.substr(0, 4);
        }
        if (value.length > 2) {
          this.value = value.substr(0, 2) + '/' + value.substr(2);
        } else {
          this.value = value;
        }
      });
    });
    </script>
{% endblock mainContent %}